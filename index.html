<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Barcode</title>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
    <style>
      #status {
        margin: 1rem 0;
        font-weight: bold;
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>Welcome to Scan Barcode</h1>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: start;
        gap: 20px;
      "
    >
      <form>
        <label for="serial_number">Serial Number:</label><br />
        <input type="text" id="serial_number" name="serial_number" /><br />
        <button type="submit">Submit</button>
      </form>
    </div>

    <div id="scan-box" style="margin: 2rem 0">
      <video
        id="bugCam"
        playsinline
        muted
        style="max-width: 280px; display: none"
      ></video>
      <br />
      <button id="startScan" type="button">Scan barcode</button>
      <div id="status"></div>
    </div>

    <script>
      const video = document.getElementById("bugCam");
      const btn = document.getElementById("startScan");
      const input = document.querySelector("#serial_number");
      const status = document.getElementById("status");

      btn.addEventListener("click", async () => {
        btn.disabled = true;
        video.style.display = "block";
        status.textContent = "‚è≥ Activating camera...";

        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: { ideal: "environment" },
              width: 640,
              height: 480,
            },
          });

          video.srcObject = stream;
          await video.play();

          console.log("‚úÖ Camera stream started");
          console.log("video.srcObject:", video.srcObject);
          status.textContent = "üì∑ Camera activated";

          function finish(code) {
            input.value = code;
            btn.textContent = "Found: " + code;
            status.textContent = "‚úÖ Code scanned: " + code;
            stream.getTracks().forEach((t) => t.stop());
            video.remove();
          }

          if ("BarcodeDetector" in window) {
            console.log("Using native BarcodeDetector");
            const detector = new BarcodeDetector({
              formats: ["ean_13", "code_128", "qr_code"],
            });
            const tick = async () => {
              const codes = await detector.detect(video);
              console.log("Detected codes:", codes);
              if (codes.length) return finish(codes[0].rawValue);
              requestAnimationFrame(tick);
            };
            tick();
          } else {
            console.log("ZXing fallback loaded");
            const codeReader = new ZXing.BrowserMultiFormatReader();
            codeReader.decodeFromVideoDevice(null, video, (result, err) => {
              if (result) {
                finish(result.getText());
                codeReader.reset();
              } else if (err) {
                console.error("ZXing error:", err);
              }
            });
          }
        } catch (err) {
          console.error("Camera error:", err);
          status.textContent = "‚ùå Failed to access camera";
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
